<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üá≥üáµ Nepal Tax & Accounting Pro Suite (v3.0)</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #003893; --secondary: #dc143c; --success: #28a745; --dark: #1a252f; --light: #f8f9fa; }
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background: #eef2f7; margin: 0; padding: 15px; }
        .wrapper { max-width: 1400px; margin: auto; display: grid; grid-template-columns: 320px 1fr 320px; gap: 15px; }
        
        .card { background: white; border-radius: 12px; padding: 18px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 15px; position: relative; border-top: 5px solid var(--primary); }
        h3 { color: var(--primary); margin-top: 0; font-size: 1rem; display: flex; align-items: center; gap: 8px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        
        /* Calculator Display */
        .calc-screen { width: 100%; background: #222; color: #0f0; text-align: right; padding: 15px; font-family: 'Courier New'; font-size: 1.5rem; border-radius: 8px; margin-bottom: 10px; box-sizing: border-box; }
        .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .calc-grid button { padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; background: #f0f0f0; }
        .calc-grid button:hover { background: #ddd; }
        .btn-op { background: #ff9f0a !important; color: white; }

        /* Form Elements */
        input, select, textarea { width: 100%; padding: 10px; margin: 5px 0 12px 0; border: 1.5px solid #dce1e7; border-radius: 6px; font-size: 14px; }
        .btn-main { background: var(--primary); color: white; border: none; padding: 12px; width: 100%; border-radius: 6px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .btn-main:hover { background: #002a6d; transform: translateY(-1px); }
        .btn-excel { background: var(--success); margin-top: 10px; }

        /* Tables & Results */
        table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 5px; }
        th, td { border: 1px solid #eee; padding: 8px; text-align: left; }
        th { background: #f4f6f9; }
        .res-area { background: #f9fbff; padding: 12px; border-radius: 6px; border-left: 4px solid var(--success); font-size: 13px; margin-top: 10px; }

        .nav-links a { display: flex; justify-content: space-between; padding: 10px; color: #444; text-decoration: none; border-bottom: 1px solid #f1f1f1; font-size: 13px; }
        .nav-links a:hover { background: #fcfcfc; color: var(--secondary); }

        /* Print Receipt Style */
        #receipt-box { display: none; padding: 20px; border: 2px solid #333; width: 300px; margin: 20px auto; background: #fff; }

        @media (max-width: 1100px) { .wrapper { grid-template-columns: 1fr; } }
        @media print { body * { display: none; } #receipt-box { display: block; } }
    </style>
</head>
<body>

<header style="background: var(--primary); color: white; padding: 15px; text-align: center; margin-bottom: 20px; border-radius: 0 0 20px 20px;">
    <h1 style="margin:0; font-size: 22px;">üá≥üáµ Nepal Accountant AI Suite - Ultra Pro</h1>
    <p style="margin:5px 0 0 0; font-size: 12px; opacity: 0.9;">Tax Acts 2058/2052 | Budget 2082/83 Compliant</p>
</header>

<div class="wrapper">
    
    <div class="col">
        <div class="card">
            <h3>üßÆ Standard Calculator</h3>
            <input type="text" id="disp" class="calc-screen" readonly value="0">
            <div class="calc-grid">
                <button onclick="cClear()" style="color:red">C</button>
                <button onclick="p('/')">/</button><button onclick="p('*')">√ó</button><button onclick="bSpace()">‚å´</button>
                <button onclick="p('7')">7</button><button onclick="p('8')">8</button><button onclick="p('9')">9</button>
                <button class="btn-op" onclick="p('-')">-</button>
                <button onclick="p('4')">4</button><button onclick="p('5')">5</button><button onclick="p('6')">6</button>
                <button class="btn-op" onclick="p('+')">+</button>
                <button onclick="p('1')">1</button><button onclick="p('2')">2</button><button onclick="p('3')">3</button>
                <button class="btn-op" onclick="res()">=</button>
                <button onclick="p('0')" style="grid-column: span 2;">0</button><button onclick="p('.')">.</button>
            </div>
        </div>

        <div class="card">
            <h3>üè¢ Official Act Links</h3>
            <div class="nav-links">
                <a href="https://ird.gov.np/" target="_blank">IRD Portal <span>‚ûî</span></a>
                <a href="https://ssf.gov.np/" target="_blank">SSF Nepal <span>‚ûî</span></a>
                <a href="https://ocr.gov.np/" target="_blank">Company Registrar <span>‚ûî</span></a>
                <a href="https://mof.gov.np/" target="_blank">Ministry of Finance <span>‚ûî</span></a>
                <a href="https://nepalbudget.gov.np/" target="_blank">Budget Portal <span>‚ûî</span></a>
            </div>
        </div>
    </div>

    <div class="col">
        <div class="card">
            <h3>üìù Comprehensive Tax & SSF Calculator</h3>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div>
                    <label>Amount (NPR)</label>
                    <input type="number" id="amt" placeholder="Enter Figure">
                </div>
                <div>
                    <label>Calculation Type</label>
                    <select id="mode">
                        <option value="excl">VAT Exclusive</option>
                        <option value="incl">VAT Inclusive</option>
                    </select>
                </div>
            </div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div>
                    <label>TDS Rate (%)</label>
                    <select id="tds">
                        <option value="0">0% (None)</option>
                        <option value="1.5">1.5% (Service - VAT Vendor)</option>
                        <option value="10">10% (Rent / Vehicle)</option>
                        <option value="15">15% (Consultancy / Meeting)</option>
                        <option value="5">5% (Interest)</option>
                    </select>
                </div>
                <div>
                    <label>SSF Applicable?</label>
                    <select id="ssf_app">
                        <option value="no">No</option>
                        <option value="yes">Yes (11% + 20%)</option>
                    </select>
                </div>
            </div>

            <button class="btn-main" onclick="processAll()">Run Comprehensive Calculation</button>
            
            <div id="results" class="res-area" style="display:none;"></div>
            <button id="excelBtn" class="btn-main btn-excel" style="display:none;" onclick="exportToExcel()">üì• Download Report (Excel)</button>
            <button id="printBtn" class="btn-main" style="display:none; background:#666;" onclick="window.print()">üñ®Ô∏è Print Voucher</button>
        </div>

        <div class="card" style="border-top-color: var(--secondary);">
            <h3>ü§ñ AI Accountant Advisor (AI Expert)</h3>
            <div id="keyCheck" style="background:#fff3f3; padding:10px; border-radius:8px; margin-bottom:10px; font-size:12px;">
                üîë API Key: <input type="password" id="apiKey" style="width:150px; margin:0; padding:4px;" placeholder="sk-or-v1-...">
                <button onclick="saveKey()" style="padding:4px 10px; cursor:pointer;">Save</button>
            </div>
            <textarea id="query" rows="4" placeholder="Ask AI: 'Journal entry for car purchase with VAT' or 'Gratuity rule as per Labor Act'"></textarea>
            <button class="btn-main" id="askBtn" onclick="askAI()">Consult Senior CA AI</button>
            <div id="aiResponse" style="margin-top:15px; border-top:1px solid #eee; padding-top:10px;"></div>
        </div>
    </div>

    <div class="col">
        <div class="card">
            <h3>üìà Current Income Tax Slabs</h3>
            <p style="font-size:11px; color:red;">FY 2082/83 (Individual/Couple)</p>
            <table>
                <tr><th>Income Slab</th><th>Rate</th></tr>
                <tr><td>1st Slab (5L/6L)</td><td>1%*</td></tr>
                <tr><td>Next 2 Lakh</td><td>10%</td></tr>
                <tr><td>Next 3 Lakh</td><td>20%</td></tr>
                <tr><td>Next 9 Lakh</td><td>30%</td></tr>
                <tr><td>Next 20 Lakh</td><td>36%</td></tr>
                <tr><td>Above 50 Lakh</td><td>39%</td></tr>
            </table>
            <p style="font-size:10px; color:#777;">*1% SST is waived if SSF is contributed.</p>
        </div>

        <div class="card" style="border-top-color: var(--success);">
            <h3>üè¢ Company Compliance</h3>
            <ul style="font-size:12px; padding-left:15px; line-height:1.8;">
                <li>Annual Return (OCR) - 6 Months</li>
                <li>Income Tax Filing - Ashwin End</li>
                <li>VAT Filing - 25th of next month</li>
                <li>Audit Report - Compulsory</li>
            </ul>
        </div>
    </div>
</div>

<div id="receipt-box">
    <h2 style="text-align:center">Tax Voucher</h2>
    <div id="printData"></div>
    <hr>
    <p style="font-size:10px; text-align:center">Generated by Nepal Tax AI Suite</p>
</div>

<script>
// 1. Storage & Key
function saveKey() { localStorage.setItem('tax_key', document.getElementById('apiKey').value); alert("Key Saved!"); location.reload(); }
if(localStorage.getItem('tax_key')) {
    document.getElementById('keyCheck').innerHTML = "‚úÖ AI Engine Connected";
}

// 2. Standard Calculator
let d = document.getElementById('disp');
function p(v) { if(d.value==="0") d.value=v; else d.value+=v; }
function cClear() { d.value="0"; }
function bSpace() { d.value = d.value.slice(0,-1) || "0"; }
function res() { try{ d.value = eval(d.value); } catch(e){ d.value="Error"; } }

// 3. Main Tax Engine
let reportData = [];

function processAll() {
    let amt = parseFloat(document.getElementById('amt').value);
    let mode = document.getElementById('mode').value;
    let tdsRate = parseFloat(document.getElementById('tds').value);
    let ssfApp = document.getElementById('ssf_app').value;

    if(isNaN(amt)) return alert("Please enter a valid amount.");

    let base, vat, total, tdsAmt, netPay, ssf_ee=0, ssf_er=0;

    if(mode === 'excl') {
        base = amt;
        vat = base * 0.13;
        total = base + vat;
    } else {
        total = amt;
        base = total / 1.13;
        vat = total - base;
    }

    tdsAmt = base * (tdsRate / 100);
    netPay = total - tdsAmt;

    let resHtml = `
        <strong>Result Summary:</strong><br>
        Taxable Base: NPR ${base.toFixed(2)}<br>
        VAT (13%): NPR ${vat.toFixed(2)}<br>
        TDS (${tdsRate}%): (NPR ${tdsAmt.toFixed(2)})<br>
        <hr>
        <b style="color:var(--primary)">Net Payable: NPR ${netPay.toFixed(2)}</b>
    `;

    if(ssfApp === 'yes') {
        ssf_ee = base * 0.11;
        ssf_er = base * 0.20;
        resHtml += `<br><br><small>SSF Employee (11%): ${ssf_ee.toFixed(2)}<br>SSF Employer (20%): ${ssf_er.toFixed(2)}</small>`;
    }

    document.getElementById('results').innerHTML = resHtml;
    document.getElementById('results').style.display = 'block';
    document.getElementById('excelBtn').style.display = 'block';
    document.getElementById('printBtn').style.display = 'block';

    // Store for Excel
    reportData = [
        { Description: "Base Amount", Value: base.toFixed(2) },
        { Description: "VAT 13%", Value: vat.toFixed(2) },
        { Description: "TDS Deducted", Value: tdsAmt.toFixed(2) },
        { Description: "Net Payable", Value: netPay.toFixed(2) }
    ];

    // For Print
    document.getElementById('printData').innerHTML = resHtml;
}

// 4. Excel Export Function
function exportToExcel() {
    const ws = XLSX.utils.json_to_sheet(reportData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "TaxReport");
    XLSX.writeFile(wb, "Nepal_Tax_Report.xlsx");
}

// 5. AI Consultation
async function askAI() {
    const key = localStorage.getItem('tax_key');
    const q = document.getElementById('query').value;
    const box = document.getElementById('aiResponse');
    if(!key) return alert("Please enter API Key first!");

    box.innerHTML = "Consulting Law Books... ‚è≥";
    document.getElementById('askBtn').disabled = true;

    try {
        const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
            method: "POST",
            headers: { "Authorization": `Bearer ${key}`, "Content-Type": "application/json" },
            body: JSON.stringify({
                "model": "stepfun/step-3.5-flash:free",
                "messages": [
                    { "role": "system", "content": "You are a Senior Nepal CA. Provide Journal entries in tables and refer to Nepal's Income Tax Act 2058. Answer in professional Roman Nepali." },
                    { "role": "user", "content": q }
                ]
            })
        });
        const data = await response.json();
        box.innerHTML = marked.parse(data.choices[0].message.content);
    } catch(e) {
        box.innerHTML = "Connection Error!";
    } finally {
        document.getElementById('askBtn').disabled = false;
    }
}
</script>

</body>
</html>