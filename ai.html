<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üá≥üáµ Nepal Accountant AI - Ultimate SaaS Suite</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #003893; --secondary: #dc143c; --success: #28a745; --dark: #1a252f; --light: #f4f7f6; }
        body { font-family: 'Inter', sans-serif; background: #eef2f7; margin: 0; padding: 0; }
        
        /* Tab System */
        .header { background: var(--primary); color: white; padding: 1rem; text-align: center; }
        .tab-bar { background: white; display: flex; justify-content: center; gap: 10px; padding: 10px; sticky: top; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .tab-btn { padding: 12px 20px; border: none; background: none; font-weight: bold; cursor: pointer; border-radius: 8px; transition: 0.3s; color: #555; }
        .tab-btn.active { background: var(--primary); color: white; }
        .tab-btn:hover:not(.active) { background: #f0f0f0; }

        .container { max-width: 1100px; margin: 20px auto; padding: 0 15px; }
        .tab-content { display: none; animation: fadeIn 0.4s; }
        .tab-content.active { display: block; }

        .card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 20px; }
        h2 { color: var(--primary); font-size: 1.4rem; border-left: 5px solid var(--secondary); padding-left: 15px; margin-bottom: 20px; }
        
        /* Grid Layouts */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        label { display: block; font-weight: 600; font-size: 13px; margin-bottom: 5px; color: #444; }
        input, select, textarea { width: 100%; padding: 12px; border: 1.5px solid #dce1e7; border-radius: 8px; box-sizing: border-box; margin-bottom: 15px; }

        /* Cash Calculator Style */
        .cash-row { display: grid; grid-template-columns: 80px 20px 100px 1fr; gap: 15px; align-items: center; margin-bottom: 8px; }
        .cash-total { background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: right; font-size: 1.2rem; font-weight: bold; color: var(--primary); }

        /* Buttons */
        .btn { padding: 12px 25px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.3s; display: inline-block; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-secondary { background: #6c757d; color: white; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @media (max-width: 768px) { .grid-2 { grid-template-columns: 1fr; } .tab-bar { flex-wrap: wrap; } }
    </style>
</head>
<body>

<div class="header">
    <h1 style="margin:0; font-size: 1.8rem;">üá≥üáµ Ultimate Nepal Accountant AI</h1>
    <p style="margin:5px 0 0 0; opacity: 0.8;">FY 2082/83 Professional Compliance Suite</p>
</div>

<div class="tab-bar">
    <button class="tab-btn active" onclick="openTab(event, 'payroll')">üí∞ Payroll & Tax</button>
    <button class="tab-btn" onclick="openTab(event, 'vat-tds')">üìä VAT & TDS</button>
    <button class="tab-btn" onclick="openTab(event, 'cash')">üíµ Cash Denomination</button>
    <button class="tab-btn" onclick="openTab(event, 'ai-expert')">ü§ñ AI Advisor</button>
    <button class="tab-btn" onclick="openTab(event, 'standard-calc')">üßÆ Calculator</button>
</div>

<div class="container">
    
    <div id="payroll" class="tab-content active">
        <div class="card">
            <h2>Monthly Salary & Income Tax (SSF Integrated)</h2>
            <div class="grid-2">
                <div>
                    <label>Monthly Basic Salary (NPR)</label>
                    <input type="number" id="mSalary" value="50000" oninput="runPayroll()">
                    
                    <label>Monthly Allowances</label>
                    <input type="number" id="mAllow" value="0" oninput="runPayroll()">

                    <label>SSF Contribution?</label>
                    <select id="pSSF" onchange="runPayroll()">
                        <option value="yes">Yes (Contributor)</option>
                        <option value="no">No</option>
                    </select>
                </div>
                <div>
                    <label>Life Insurance Premium (Annual Deduction)</label>
                    <input type="number" id="dedLife" placeholder="Max 40,000" oninput="runPayroll()">

                    <label>Health Insurance Premium (Annual Deduction)</label>
                    <input type="number" id="dedHealth" placeholder="Max 20,000" oninput="runPayroll()">

                    <label>Home Loan Interest (Annual Deduction)</label>
                    <input type="number" id="dedHome" placeholder="If applicable" oninput="runPayroll()">

                    <label>Marital Status</label>
                    <select id="pStatus" onchange="runPayroll()">
                        <option value="single">Single</option>
                        <option value="married">Married</option>
                    </select>
                </div>
            </div>
            <div id="payrollResult" class="card" style="background:#f0f7ff; border:none; margin-top:20px;">
                </div>
            <button class="btn btn-success" onclick="exportPayroll()">üì• Export Payroll to Excel</button>
        </div>
    </div>

    <div id="vat-tds" class="tab-content">
        <div class="card">
            <h2>VAT & TDS Quick Calculator</h2>
            <div class="grid-2">
                <div>
                    <label>Invoice Amount</label>
                    <input type="number" id="vAmt" placeholder="Enter Amount">
                    <label>Mode</label>
                    <select id="vMode">
                        <option value="excl">VAT Exclusive (Add 13%)</option>
                        <option value="incl">VAT Inclusive (Extract 13%)</option>
                    </select>
                </div>
                <div>
                    <label>TDS Rate (%)</label>
                    <select id="vTds">
                        <option value="0">0%</option>
                        <option value="1.5">1.5% (VAT Service)</option>
                        <option value="10">10% (Rent)</option>
                        <option value="15">15% (Consultancy)</option>
                    </select>
                </div>
            </div>
            <button class="btn btn-primary" onclick="runVatTds()">Calculate</button>
            <div id="vatResult" style="margin-top:20px;"></div>
        </div>
    </div>

    <div id="cash" class="tab-content">
        <div class="card">
            <h2>Cash Denomination Counter</h2>
            <div id="cashRows">
                <script>
                    const notes = [1000, 500, 100, 50, 20, 10, 5, 2, 1];
                    notes.forEach(n => {
                        document.write(`
                            <div class="cash-row">
                                <span>Rs. ${n}</span>
                                <span>√ó</span>
                                <input type="number" class="cash-qty" data-val="${n}" placeholder="Qty" oninput="runCash()">
                                <input type="text" class="cash-sub" readonly value="0" style="margin:0; background:#eee">
                            </div>
                        `);
                    });
                </script>
            </div>
            <div class="cash-total" id="cashFinal">Total: Rs. 0</div>
            <button class="btn btn-secondary" onclick="resetCash()">Reset Counter</button>
        </div>
    </div>

    <div id="ai-expert" class="tab-content">
        <div class="card">
            <h2>Nepal Tax Expert AI (CA GPT)</h2>
            <label>OpenRouter API Key (One-time setup)</label>
            <input type="password" id="aiKey" placeholder="sk-or-v1-...">
            <textarea id="aiQ" rows="5" placeholder="Example: Office rent payment garda PAN bill paye k TDS katne?"></textarea>
            <button class="btn btn-primary" id="aiBtn" onclick="askExpert()">Ask Senior CA AI</button>
            <div id="aiResponse" style="margin-top:20px; line-height:1.6;"></div>
        </div>
    </div>

    <div id="standard-calc" class="tab-content">
        <div class="card" style="max-width:400px; margin:auto;">
            <h2>Standard Calculator</h2>
            <input type="text" id="calcDisp" readonly style="font-size:2rem; text-align:right; height:60px; background:#222; color:#0f0;">
            <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:10px;">
                <button class="btn btn-secondary" onclick="cClr()">C</button>
                <button class="btn btn-secondary" onclick="cP('/')">/</button>
                <button class="btn btn-secondary" onclick="cP('*')">√ó</button>
                <button class="btn btn-secondary" onclick="cBs()">‚å´</button>
                <button class="btn" onclick="cP('7')">7</button>
                <button class="btn" onclick="cP('8')">8</button>
                <button class="btn" onclick="cP('9')">9</button>
                <button class="btn btn-primary" onclick="cP('-')">-</button>
                <button class="btn" onclick="cP('4')">4</button>
                <button class="btn" onclick="cP('5')">5</button>
                <button class="btn" onclick="cP('6')">6</button>
                <button class="btn btn-primary" onclick="cP('+')">+</button>
                <button class="btn" onclick="cP('1')">1</button>
                <button class="btn" onclick="cP('2')">2</button>
                <button class="btn" onclick="cP('3')">3</button>
                <button class="btn btn-success" onclick="cRes()">=</button>
                <button class="btn" onclick="cP('0')" style="grid-column: span 2;">0</button>
                <button class="btn" onclick="cP('.')">.</button>
            </div>
        </div>
    </div>

</div>

<script>
// TAB LOGIC
function openTab(evt, tabName) {
    let content = document.getElementsByClassName("tab-content");
    for (let i = 0; i < content.length; i++) content[i].classList.remove("active");
    let btns = document.getElementsByClassName("tab-btn");
    for (let i = 0; i < btns.length; i++) btns[i].classList.remove("active");
    document.getElementById(tabName).classList.add("active");
    evt.currentTarget.classList.add("active");
}

// 1. ADVANCED PAYROLL LOGIC (Annualized to Monthly)
function runPayroll() {
    let basic = parseFloat(document.getElementById('mSalary').value) || 0;
    let allow = parseFloat(document.getElementById('mAllow').value) || 0;
    let monthlyGross = basic + allow;
    let annualGross = monthlyGross * 12;
    
    // SSF Deductions
    let ssf_ee_monthly = 0;
    if(document.getElementById('pSSF').value === 'yes') {
        ssf_ee_monthly = basic * 0.11;
    }
    
    let annualTaxable = annualGross - (ssf_ee_monthly * 12);
    
    // Deductions
    annualTaxable -= (parseFloat(document.getElementById('dedLife').value) || 0);
    annualTaxable -= (parseFloat(document.getElementById('dedHealth').value) || 0);
    annualTaxable -= (parseFloat(document.getElementById('dedHome').value) || 0);

    // Nepal Tax Slab (FY 81/82)
    let status = document.getElementById('pStatus').value;
    let slab1 = (status === 'single') ? 500000 : 600000;
    let tax = 0;
    let temp = annualTaxable;

    // Simplified slab logic
    if(temp > slab1) {
        // 1% Social Security Tax (waived if SSF contributor)
        if(document.getElementById('pSSF').value === 'no') tax += slab1 * 0.01;
        temp -= slab1;
        // 10% next 2L
        let s2 = Math.min(temp, 200000); tax += s2 * 0.10; temp -= s2;
        // 20% next 3L
        if(temp > 0) { let s3 = Math.min(temp, 300000); tax += s3 * 0.20; temp -= s3; }
        // 30% next 9L
        if(temp > 0) { let s4 = Math.min(temp, 900000); tax += s4 * 0.30; temp -= s4; }
        // ... Higher slabs
    } else {
        if(document.getElementById('pSSF').value === 'no') tax = temp * 0.01;
    }

    let monthlyTax = tax / 12;
    let takeHome = monthlyGross - ssf_ee_monthly - monthlyTax;

    document.getElementById('payrollResult').innerHTML = `
        <div class="grid-2">
            <div>
                <strong>Gross Monthly:</strong> Rs. ${monthlyGross.toLocaleString()}<br>
                <strong>Employee SSF (11%):</strong> Rs. ${ssf_ee_monthly.toLocaleString()}<br>
                <strong>Monthly Income Tax:</strong> Rs. ${monthlyTax.toLocaleString()}
            </div>
            <div style="text-align:right">
                <h3 style="margin:0; color:var(--success)">Net Take Home</h3>
                <h1 style="margin:0">Rs. ${takeHome.toLocaleString()}</h1>
            </div>
        </div>
    `;
}

// 2. CASH DENOMINATION LOGIC
function runCash() {
    let rows = document.querySelectorAll('.cash-row');
    let total = 0;
    rows.forEach(row => {
        let qty = parseFloat(row.querySelector('.cash-qty').value) || 0;
        let val = parseFloat(row.querySelector('.cash-qty').dataset.val);
        let sub = qty * val;
        row.querySelector('.cash-sub').value = sub.toLocaleString();
        total += sub;
    });
    document.getElementById('cashFinal').innerText = "Total: Rs. " + total.toLocaleString();
}
function resetCash() { 
    document.querySelectorAll('.cash-qty').forEach(i => i.value = ""); 
    runCash(); 
}

// 3. VAT/TDS LOGIC
function runVatTds() {
    let amt = parseFloat(document.getElementById('vAmt').value) || 0;
    let mode = document.getElementById('vMode').value;
    let tRate = parseFloat(document.getElementById('vTds').value);
    
    let base = (mode === 'excl') ? amt : amt / 1.13;
    let vat = base * 0.13;
    let tds = base * (tRate/100);
    let net = (base + vat) - tds;

    document.getElementById('vatResult').innerHTML = `
        <div class="card" style="border-left:5px solid var(--primary)">
            Base: ${base.toFixed(2)} | VAT: ${vat.toFixed(2)} | TDS: ${tds.toFixed(2)}<br>
            <strong>Net Payable: Rs. ${net.toFixed(2)}</strong>
        </div>
    `;
}

// 4. AI ADVISOR
async function askExpert() {
    const key = document.getElementById('aiKey').value || localStorage.getItem('tax_key');
    if(!key) return alert("API Key halnus");
    localStorage.setItem('tax_key', key);
    
    const box = document.getElementById('aiResponse');
    box.innerHTML = "Thinking... ‚è≥";
    
    try {
        const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
            method: "POST",
            headers: { "Authorization": `Bearer ${key}`, "Content-Type": "application/json" },
            body: JSON.stringify({
                "model": "stepfun/step-3.5-flash:free",
                "messages": [{ "role": "system", "content": "You are a Senior Nepal CA. Answer in professional Roman Nepali with markdown tables for entries." },
                             { "role": "user", "content": document.getElementById('aiQ').value }]
            })
        });
        const data = await res.json();
        box.innerHTML = marked.parse(data.choices[0].message.content);
    } catch(e) { box.innerHTML = "Error connecting AI."; }
}

// 5. CALCULATOR
let cd = document.getElementById('calcDisp');
function cP(v) { if(cd.value==="0") cd.value=v; else cd.value+=v; }
function cClr() { cd.value="0"; }
function cBs() { cd.value = cd.value.slice(0,-1) || "0"; }
function cRes() { try{ cd.value = eval(cd.value); } catch(e){ cd.value="Error"; } }

// Init
runPayroll();
</script>

</body>
</html>